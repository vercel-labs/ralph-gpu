var e={};e.d=(t,r)=>{for(var i in r)e.o(r,i)&&!e.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:r[i]})},e.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);class t extends Error{constructor(e="WebGPU is not supported in this browser"){super(e),this.name="WebGPUNotSupportedError",Object.setPrototypeOf(this,t.prototype)}}class r extends Error{constructor(e="Failed to create GPU device"){super(e),this.name="DeviceCreationError",Object.setPrototypeOf(this,r.prototype)}}class i extends Error{line;column;source;constructor(e,t,r,s){super(e),this.name="ShaderCompileError",this.line=t,this.column=r,this.source=s,Object.setPrototypeOf(this,i.prototype)}}class s{_gpuSampler;_descriptor;constructor(e,t={}){this._descriptor=t,this._gpuSampler=e.createSampler({magFilter:t.magFilter||"linear",minFilter:t.minFilter||"linear",mipmapFilter:t.mipmapFilter||"linear",addressModeU:t.addressModeU||"clamp-to-edge",addressModeV:t.addressModeV||"clamp-to-edge",addressModeW:t.addressModeW||"clamp-to-edge",lodMinClamp:t.lodMinClamp??0,lodMaxClamp:t.lodMaxClamp??32,compare:t.compare,maxAnisotropy:t.maxAnisotropy??1})}get gpuSampler(){return this._gpuSampler}get descriptor(){return this._descriptor}dispose(){}}function a(){return`
struct Globals {
  resolution: vec2f,
  time: f32,
  deltaTime: f32,
  frame: u32,
  aspect: f32,
}
@group(0) @binding(0) var<uniform> globals: Globals;
`}function n(e){if("number"==typeof e||"boolean"==typeof e)return 4;if(Array.isArray(e)||e instanceof Float32Array){let t=e.length;if(2===t)return 8;if(3===t)return 12;if(4===t)return 16;if(9===t)return 48;if(16===t)return 64}return 0}function o(e){if("number"==typeof e||"boolean"==typeof e)return 4;if(Array.isArray(e)||e instanceof Float32Array){let t=e.length;if(2===t)return 8}return 16}function u(e){let t=0;for(let r in e){let i=e[r].value;if(i&&"object"==typeof i&&!(i instanceof Float32Array)&&!Array.isArray(i)&&("createView"in i||"texture"in i))continue;let s=n(i),a=o(i);s>0&&(t=Math.ceil(t/a)*a+s)}return t>0?16*Math.ceil(t/16):0}function h(e,t,r){if("number"==typeof r)return e[t/4]=r,4;if("boolean"==typeof r)return new Uint32Array(e.buffer,t,1)[0]=+!!r,4;if(Array.isArray(r)||r instanceof Float32Array){let i=r.length;if(2===i)return e[t/4]=r[0],e[t/4+1]=r[1],8;if(3===i)return e[t/4]=r[0],e[t/4+1]=r[1],e[t/4+2]=r[2],12;if(4===i)return e[t/4]=r[0],e[t/4+1]=r[1],e[t/4+2]=r[2],e[t/4+3]=r[3],16;if(9===i){for(let i=0;i<3;i++)e[t/4+4*i]=r[3*i],e[t/4+4*i+1]=r[3*i+1],e[t/4+4*i+2]=r[3*i+2];return 48}if(16===i){for(let i=0;i<16;i++)e[t/4+i]=r[i];return 64}}return 0}function l(e,t,r,i){if(0===i)return;let s=new Float32Array(i/4),a=0;for(let e in r){let t=r[e].value;if(t&&"object"==typeof t&&!(t instanceof Float32Array)&&!Array.isArray(t)&&("createView"in t||"texture"in t))continue;let i=n(t),u=o(t);if(i>0){let e=h(s,a=Math.ceil(a/u)*u,t);a+=e}}e.queue.writeBuffer(t,0,s.buffer)}function f(e){return e&&"none"!==e?"object"==typeof e&&"color"in e?e:({alpha:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha",operation:"add"},alpha:{srcFactor:"one",dstFactor:"one-minus-src-alpha",operation:"add"}},additive:{color:{srcFactor:"src-alpha",dstFactor:"one",operation:"add"},alpha:{srcFactor:"one",dstFactor:"one",operation:"add"}},multiply:{color:{srcFactor:"dst",dstFactor:"zero",operation:"add"},alpha:{srcFactor:"one",dstFactor:"zero",operation:"add"}},screen:{color:{srcFactor:"one",dstFactor:"one-minus-src",operation:"add"},alpha:{srcFactor:"one",dstFactor:"one-minus-src-alpha",operation:"add"}}})[e]:void 0}function c(e){let t=new Map,r=new Map;for(let[t,i]of Object.entries(e)){let e=i.value;e&&"object"==typeof e&&!(e instanceof Float32Array)&&!Array.isArray(e)&&(e instanceof s?r.set(t,e.gpuSampler):("compare"in e||"addressModeU"in e&&"magFilter"in e)&&r.set(t,e))}for(let[i,s]of Object.entries(e)){let e=s.value;if(e&&"object"==typeof e&&!(e instanceof Float32Array)&&!Array.isArray(e)){if("createView"in e&&"function"==typeof e.createView){let s=r.get(i+"Sampler")||r.get(i.replace(/Tex(ture)?$/,"Sampler"))||r.get(i.replace(/Texture$/,"")+"Sampler");t.set(i,{texture:e,sampler:s})}else if("texture"in e){let s=e.texture,a=r.get(i+"Sampler")||r.get(i.replace(/Tex(ture)?$/,"Sampler"))||r.get(i.replace(/Texture$/,"")+"Sampler");!a&&"sampler"in e&&(a=e.sampler),t.set(i,{texture:s,sampler:a})}}}return t}function m(e,t=1){let r,i={textures:new Map,samplers:new Map,storage:new Map,storageTextures:new Map},s=RegExp(`@group\\(${t}\\)\\s+@binding\\((\\d+)\\)\\s+var(?:<([^>]+)>)?\\s+(\\w+)\\s*:\\s*([^;]+);`,"g");for(;null!==(r=s.exec(e));){let e=parseInt(r[1]),t=r[2],s=r[3],a=r[4].trim();"uniform"===t?i.uniformBuffer=e:t&&(t.startsWith("storage")||"storage, read"===t)?i.storage.set(s,e):a.includes("texture_storage")?i.storageTextures.set(s,e):a.includes("texture_")?i.textures.set(s,e):a.includes("sampler")&&i.samplers.set(s,e)}return i}function p(e){if(e&&"object"==typeof e&&!(e instanceof Float32Array)){if(e instanceof s||"compare"in e||"addressModeU"in e&&"magFilter"in e)return!1;if("createView"in e&&"function"==typeof e.createView||"texture"in e)return!0}return!1}let g=0;function d(){return`evt_${++g}_${performance.now().toFixed(0)}`}function b(e,t,r){return e*t*({rgba8unorm:4,rgba16float:8,r16float:2,rg16float:4,r32float:4})[r]}class w{_gpuTexture;constructor(e){this._gpuTexture=e}get texture(){return this._gpuTexture}createView(){return this._gpuTexture.createView()}_updateTexture(e){this._gpuTexture=e}}class v{device;context;_gpuTexture;_textureRef;_view;_sampler;_width;_height;_format;_filter;_wrap;_usage;constructor(e,t,r,i={},s){if(this.device=e,this.context=s,this._width=t,this._height=r,this._format=i.format||"rgba8unorm",this._filter=i.filter||"linear",this._wrap=i.wrap||"clamp",this._usage=i.usage||"render",this.createTexture(),this.createSampler(),this.context){let e={type:"memory",timestamp:performance.now(),id:d(),resourceType:"texture",size:b(this._width,this._height,this._format),action:"allocate"};this.context.emitEvent(e)}}createTexture(){let e=GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_SRC;("render"===this._usage||"both"===this._usage)&&(e|=GPUTextureUsage.RENDER_ATTACHMENT),("storage"===this._usage||"both"===this._usage)&&(e|=GPUTextureUsage.STORAGE_BINDING),this._gpuTexture=this.device.createTexture({size:{width:this._width,height:this._height},format:{rgba8unorm:"rgba8unorm",rgba16float:"rgba16float",r16float:"r16float",rg16float:"rg16float",r32float:"r32float"}[this._format],usage:e}),this._view=this._gpuTexture.createView(),this._textureRef?this._textureRef._updateTexture(this._gpuTexture):this._textureRef=new w(this._gpuTexture)}createSampler(){let e="clamp"===this._wrap?"clamp-to-edge":"repeat"===this._wrap?"repeat":"mirror-repeat";this._sampler=this.device.createSampler({magFilter:this._filter,minFilter:this._filter,addressModeU:e,addressModeV:e})}get texture(){return this._textureRef}get gpuTexture(){return this._gpuTexture}get view(){return this._view}get sampler(){return this._sampler}get width(){return this._width}get height(){return this._height}get format(){return this._format}get usage(){return this._usage}resize(e,t){if((e!==this._width||t!==this._height)&&(this._gpuTexture.destroy(),this._width=e,this._height=t,this.createTexture(),this.context)){let e={type:"memory",timestamp:performance.now(),id:d(),resourceType:"texture",size:b(this._width,this._height,this._format),action:"resize"};this.context.emitEvent(e)}}async readPixels(e=0,t=0,r=this._width,i=this._height){let s,a="rgba8unorm"===this._format?4:"r16float"===this._format?2:"rg16float"===this._format?4:"rgba16float"===this._format?8:(this._format,4),n="r16float"===this._format||"rg16float"===this._format||"rgba16float"===this._format,o=(this._format,r*a),u=256*Math.ceil(o/256),h=this.device.createBuffer({size:u*i,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ}),l=this.device.createCommandEncoder();l.copyTextureToBuffer({texture:this._gpuTexture,origin:{x:e,y:t,z:0}},{buffer:h,bytesPerRow:u},{width:r,height:i,depthOrArrayLayers:1}),this.device.queue.submit([l.finish()]),await h.mapAsync(GPUMapMode.READ);let f=h.getMappedRange();if(u===o)s=new Uint8Array(f.slice(0));else{let e=new Uint8Array(f);s=new Uint8Array(o*i);for(let t=0;t<i;t++){let r=t*u,i=t*o;s.set(e.subarray(r,r+o),i)}}if(h.unmap(),h.destroy(),"rgba8unorm"===this._format)return s;if(n){var c=new Uint16Array(s.buffer);let e=new Float32Array(c.length);for(let t=0;t<c.length;t++)e[t]=function(e){let t=(32768&e)>>15,r=(31744&e)>>10,i=1023&e;if(0===r){if(0===i)return t?-0:0;let e=i/1024*6103515625e-14;return t?-e:e}if(31===r)return 0===i?t?-1/0:1/0:NaN;let s=(1+i/1024)*Math.pow(2,r-15);return t?-s:s}(c[t]);return e}return new Float32Array(s.buffer)}dispose(){if(this.context){let e={type:"memory",timestamp:performance.now(),id:d(),resourceType:"texture",size:b(this._width,this._height,this._format),action:"free"};this.context.emitEvent(e)}this._gpuTexture.destroy()}}class y{device;targets;_width;_height;constructor(e,t,r,i){for(let[s,a]of(this.device=e,this._width=r,this._height=i,this.targets=new Map,Object.entries(t))){let t=new v(e,r,i,a);this.targets.set(s,t)}}get(e){return this.targets.get(e)}getViews(){return Array.from(this.targets.values()).map(e=>e.view)}getFormats(){return Array.from(this.targets.values()).map(e=>e.format)}getFirstTarget(){let e=this.targets.values().next();return e.done?void 0:e.value}get width(){return this._width}get height(){return this._height}resize(e,t){for(let r of(this._width=e,this._height=t,this.targets.values()))r.resize(e,t)}dispose(){for(let e of this.targets.values())e.dispose();this.targets.clear()}}let _={get:(e,t)=>"string"!=typeof t||Reflect.has(e,t)?Reflect.get(e,t):e.get(t)};class x{device;userFragmentWGSL;fragmentWGSL;_uniforms;_simpleUniforms=null;useSimpleMode=!1;generatedBindings=null;pipelines=new Map;uniformBuffer=null;uniformBufferSize=0;storageBuffers=new Map;globalsBuffer;blendMode;context;usesGlobals;constructor(e,t,r,i,s={},a){if(this.device=e,this.userFragmentWGSL=t,this.globalsBuffer=r,this.blendMode=s.blend,this.context=i,this.usesGlobals=/\bglobals\.\w+/.test(t),a&&!/@group\(1\)\s+@binding/.test(t)){for(let[e,r]of(this.useSimpleMode=!0,this._simpleUniforms=a,this.generatedBindings=function(e){let t=[],r={textures:new Map,samplers:new Map,storage:new Map,storageTextures:new Map},i=[],s=[],a=0;for(let[i,s]of Object.entries(e))if(p(s)){t.push(`@group(1) @binding(${a}) var ${i}: texture_2d<f32>;`),r.textures.set(i,a),a++;let e=`${i}Sampler`;t.push(`@group(1) @binding(${a}) var ${e}: sampler;`),r.samplers.set(e,a),a++}for(let[t,r]of Object.entries(e))if(!p(r)){let e=function(e){if("number"==typeof e)return"f32";if("boolean"==typeof e)return"u32";if(Array.isArray(e)||e instanceof Float32Array){let t=e.length;if(2===t)return"vec2f";if(3===t)return"vec3f";if(4===t)return"vec4f";if(9===t)return"mat3x3f";if(16===t)return"mat4x4f"}return null}(r);e&&(i.push({name:t,type:e}),s.push(t))}if(i.length>0){for(let e of(t.push(""),t.push("struct _Uniforms {"),i))t.push(`  ${e.name}: ${e.type},`);t.push("}"),t.push(`@group(1) @binding(${a}) var<uniform> uniforms: _Uniforms;`),r.uniformBuffer=a}return{wgsl:t.join(`
`),bindings:r,scalarUniformNames:s}}(a),this.fragmentWGSL=this.generatedBindings.wgsl+`

`+t,this._uniforms={},Object.entries(a)))this._uniforms[e]={value:r};this.uniformBufferSize=function(e){let t=0;for(let r of Object.values(e)){if(p(r))continue;let e=n(r),i=o(r);e>0&&(t=Math.ceil(t/i)*i+e)}return t>0?16*Math.ceil(t/16):0}(a),this.uniformBufferSize>0&&(this.uniformBuffer=e.createBuffer({size:this.uniformBufferSize,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}))}else this.useSimpleMode=!1,this.fragmentWGSL=t,this._uniforms=s.uniforms||{},Object.keys(this._uniforms).length>0&&(this.uniformBufferSize=u(this._uniforms),this.uniformBufferSize>0&&(this.uniformBuffer=e.createBuffer({size:this.uniformBufferSize,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST})))}get uniforms(){return this._uniforms}set(e,t){this.useSimpleMode&&this._simpleUniforms&&(this._simpleUniforms[e]=t),this._uniforms[e]?this._uniforms[e].value=t:this._uniforms[e]={value:t}}getPipeline(e){if(this.pipelines.has(e))return this.pipelines.get(e);let t=this.usesGlobals?a():"",r=`
${t}

struct VertexOutput {
  @builtin(position) position: vec4f,
}

@vertex
fn main(@builtin(vertex_index) vertexIndex: u32) -> VertexOutput {
  var pos = array<vec2f, 6>(
    vec2f(-1.0, -1.0),
    vec2f(1.0, -1.0),
    vec2f(-1.0, 1.0),
    vec2f(-1.0, 1.0),
    vec2f(1.0, -1.0),
    vec2f(1.0, 1.0),
  );
  
  var output: VertexOutput;
  output.position = vec4f(pos[vertexIndex], 0.0, 1.0);
  return output;
}
`,s=`
${t}
${this.fragmentWGSL}
`;try{let t=this.device.createShaderModule({code:r}),a=this.device.createShaderModule({code:s});a.getCompilationInfo().then(e=>{for(let t of e.messages)if("error"===t.type)throw new i(t.message,t.lineNum,t.linePos,s)});let n=f(this.blendMode),o=this.device.createRenderPipeline({layout:"auto",vertex:{module:t,entryPoint:"main"},fragment:{module:a,entryPoint:"main",targets:[{format:e,blend:n}]},primitive:{topology:"triangle-list"}});return this.pipelines.set(e,o),o}catch(e){throw e instanceof i,e}}storage(e,t){this.storageBuffers.set(e,t),this.pipelines.clear()}draw(){this.context.drawPass(this)}drawInternal(e,t,r){let i=this.context.getTarget(),a="screen",u=this.context.width,f=this.context.height;i instanceof v?(a="texture",u=i.width,f=i.height):i instanceof y&&(a="texture",u=i.width,f=i.height);let g={type:"draw",phase:"start",timestamp:performance.now(),id:d(),source:"pass",vertexCount:6,instanceCount:1,topology:"triangle-list",target:a,targetSize:[u,f]};this.context.emitEvent(g);let b=this.getPipeline(r);this.uniformBuffer&&this.uniformBufferSize>0&&(this.useSimpleMode&&this._simpleUniforms?function(e,t,r,i){if(0===i)return;let s=new Float32Array(i/4),a=0;for(let e of Object.values(r)){if(p(e))continue;let t=n(e),r=o(e);t>0&&(h(s,a=Math.ceil(a/r)*r,e),a+=t)}e.queue.writeBuffer(t,0,s.buffer)}(this.device,this.uniformBuffer,this._simpleUniforms,this.uniformBufferSize):l(this.device,this.uniformBuffer,this._uniforms,this.uniformBufferSize));let w=e.beginRenderPass(t);if(w.setPipeline(b),this.usesGlobals){let e=this.device.createBindGroup({layout:b.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:this.globalsBuffer}}]});w.setBindGroup(0,e)}let _=this.useSimpleMode&&this.generatedBindings?this.generatedBindings.bindings:m(this.fragmentWGSL,1),x=[];for(let[e,{texture:t,sampler:r}]of(this.uniformBuffer&&void 0!==_.uniformBuffer&&x.push({binding:_.uniformBuffer,resource:{buffer:this.uniformBuffer}}),this.useSimpleMode&&this._simpleUniforms?function(e){let t=new Map,r=new Map;for(let[t,i]of Object.entries(e))i&&"object"==typeof i&&!(i instanceof Float32Array)&&(i instanceof s?r.set(t,i.gpuSampler):("compare"in i||"addressModeU"in i&&"magFilter"in i)&&r.set(t,i));for(let[i,s]of Object.entries(e))if(s&&"object"==typeof s&&!(s instanceof Float32Array)){if("createView"in s&&"function"==typeof s.createView){let e=r.get(i+"Sampler")||r.get(i.replace(/Tex$/,"Sampler"));t.set(i,{texture:s,sampler:e})}else if("texture"in s){let e=s.texture,a=r.get(i+"Sampler")||r.get(i.replace(/Tex$/,"Sampler"));!a&&"sampler"in s&&(a=s.sampler),t.set(i,{texture:e,sampler:a})}}return t}(this._simpleUniforms):c(this._uniforms))){let i=_.storageTextures.get(e);if(void 0!==i){x.push({binding:i,resource:t.createView()});continue}let s=_.textures.get(e);if(void 0!==s&&(x.push({binding:s,resource:t.createView()}),r)){let t=_.samplers.get(`${e}Sampler`);void 0===t&&(t=_.samplers.get(`${e}_sampler`)),void 0===t&&e.endsWith("Tex")&&(t=_.samplers.get(`${e.slice(0,-3)}Sampler`)),void 0===t&&e.endsWith("Texture")&&(t=_.samplers.get(`${e.slice(0,-7)}Sampler`)),void 0!==t?x.push({binding:t,resource:r}):_.samplers.size>0&&console.warn(`[ralph-gpu] Sampler provided for texture '${e}' but could not find matching sampler binding in shader.`)}}for(let[e,t]of this.storageBuffers){let r=_.storage.get(e);void 0!==r&&x.push({binding:r,resource:{buffer:t.gpuBuffer}})}if(x.length>0){let e=b.getBindGroupLayout(1),t=this.device.createBindGroup({layout:e,entries:x});w.setBindGroup(1,t)}w.draw(6,1,0,0),w.end();let T={type:"draw",phase:"end",timestamp:performance.now(),id:d(),source:"pass",vertexCount:6,instanceCount:1,topology:"triangle-list",target:a,targetSize:[u,f]};this.context.emitEvent(T)}dispose(){this.uniformBuffer&&this.uniformBuffer.destroy()}}class T{device;wgsl;_uniforms;pipelines=new Map;uniformBuffer=null;uniformBufferSize=0;storageBuffers=new Map;globalsBuffer;blendMode;vertexCount;instances;topology;context;usesGlobals;indexBuffer=null;indexFormat="uint32";indexCount=0;constructor(e,t,r,i,s={}){this.device=e,this.wgsl=t,this._uniforms=s.uniforms||{},this.globalsBuffer=r,this.blendMode=s.blend,this.vertexCount=s.vertexCount||3,this.instances=s.instances||1,this.topology=s.topology||"triangle-list",this.context=i,this.usesGlobals=/\bglobals\.\w+/.test(t),s.indexBuffer&&(this.indexBuffer=s.indexBuffer,this.indexFormat=s.indexFormat||"uint32",this.indexCount=s.indexCount||0),Object.keys(this._uniforms).length>0&&(this.uniformBufferSize=u(this._uniforms),this.uniformBufferSize>0&&(this.uniformBuffer=e.createBuffer({size:this.uniformBufferSize,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST})))}get uniforms(){return this._uniforms}getPipeline(e){let t=`${e}:${this.topology}`;if(this.pipelines.has(t))return this.pipelines.get(t);let r=this.usesGlobals?`${a()}
${this.wgsl}`:this.wgsl;try{let s=this.device.createShaderModule({code:r});s.getCompilationInfo().then(e=>{for(let t of e.messages)if("error"===t.type)throw new i(t.message,t.lineNum,t.linePos,r)});let a=f(this.blendMode),n=this.device.createRenderPipeline({layout:"auto",vertex:{module:s,entryPoint:"vs_main"},fragment:{module:s,entryPoint:"fs_main",targets:[{format:e,blend:a}]},primitive:{topology:this.topology}});return this.pipelines.set(t,n),n}catch(e){throw e instanceof i,e}}storage(e,t){this.storageBuffers.set(e,t),this.pipelines.clear()}draw(){this.context.drawMaterial(this)}drawInternal(e,t,r){let i={type:"draw",phase:"start",timestamp:performance.now(),id:d(),source:"material",vertexCount:this.indexBuffer?this.indexCount:this.vertexCount,instanceCount:this.instances,topology:this.topology,target:this.context.isRenderingToTexture()?"texture":"screen",targetSize:[this.context.width,this.context.height]};this.context.emitEvent(i);let s=this.getPipeline(r);this.uniformBuffer&&this.uniformBufferSize>0&&l(this.device,this.uniformBuffer,this._uniforms,this.uniformBufferSize);let a=e.beginRenderPass(t);if(a.setPipeline(s),this.usesGlobals){let e=this.device.createBindGroup({layout:s.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:this.globalsBuffer}}]});a.setBindGroup(0,e)}let n=m(this.wgsl,1),o=[];for(let[e,{texture:t,sampler:r}]of(this.uniformBuffer&&void 0!==n.uniformBuffer&&o.push({binding:n.uniformBuffer,resource:{buffer:this.uniformBuffer}}),c(this._uniforms))){let i=n.storageTextures.get(e);if(void 0!==i){o.push({binding:i,resource:t.createView()});continue}let s=n.textures.get(e);if(void 0!==s&&(o.push({binding:s,resource:t.createView()}),r)){let t=n.samplers.get(`${e}Sampler`);void 0===t&&(t=n.samplers.get(`${e}_sampler`)),void 0===t&&e.endsWith("Tex")&&(t=n.samplers.get(`${e.slice(0,-3)}Sampler`)),void 0===t&&e.endsWith("Texture")&&(t=n.samplers.get(`${e.slice(0,-7)}Sampler`)),void 0!==t?o.push({binding:t,resource:r}):n.samplers.size>0&&console.warn(`[ralph-gpu] Sampler provided for texture '${e}' but could not find matching sampler binding in shader.`)}}for(let[e,t]of this.storageBuffers){let r=n.storage.get(e);void 0!==r&&o.push({binding:r,resource:{buffer:t.gpuBuffer}})}if(o.length>0){let e=s.getBindGroupLayout(1),t=this.device.createBindGroup({layout:e,entries:o});a.setBindGroup(1,t)}this.indexBuffer?(a.setIndexBuffer(this.indexBuffer.gpuBuffer,this.indexFormat),a.drawIndexed(this.indexCount,this.instances,0,0,0)):a.draw(this.vertexCount,this.instances,0,0),a.end();let u={type:"draw",phase:"end",timestamp:performance.now(),id:d(),source:"material",vertexCount:this.indexBuffer?this.indexCount:this.vertexCount,instanceCount:this.instances,topology:this.topology,target:this.context.isRenderingToTexture()?"texture":"screen",targetSize:[this.context.width,this.context.height]};this.context.emitEvent(u)}dispose(){this.uniformBuffer&&this.uniformBuffer.destroy()}}class S{device;wgsl;_uniforms;pipeline=null;uniformBuffer=null;uniformBufferSize=0;storageBuffers=new Map;globalsBuffer;workgroupSize;needsRebuild=!0;usesGlobals=!1;context;constructor(e,t,r,i,s={}){this.device=e,this.wgsl=t,this._uniforms=s.uniforms||{},this.globalsBuffer=r,this.context=i;let a=s.workgroupSize||[1];this.workgroupSize=[a[0]||1,a[1]||1,a[2]||1],Object.keys(this._uniforms).length>0&&(this.uniformBufferSize=u(this._uniforms),this.uniformBufferSize>0&&(this.uniformBuffer=e.createBuffer({size:this.uniformBufferSize,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST})))}get uniforms(){return this._uniforms}buildPipeline(){this.usesGlobals=/\bglobals\.\w+/.test(this.wgsl);let e=this.usesGlobals?`${a()}
${this.wgsl}`:this.wgsl;try{var t;let r=this.device.createShaderModule({code:e});r.getCompilationInfo().then(t=>{for(let r of t.messages)if("error"===r.type)throw new i(r.message,r.lineNum,r.linePos,e)});let s=(t=this.wgsl,m(t,1)),a=function(e,t,r,i){let s=[],a=[];for(let[e,i]of t.textures)if(r[e]){let t=r[e].value;t&&"object"==typeof t&&("createView"in t||"texture"in t)||s.push(`  - binding ${i}: texture_2d<f32> '${e}' ✗ NOT A TEXTURE`)}else s.push(`  - binding ${i}: texture_2d<f32> '${e}' ✗ MISSING`);for(let[e,i]of t.storageTextures)if(r[e]){let t=r[e].value;t&&"object"==typeof t&&("createView"in t||"texture"in t)||s.push(`  - binding ${i}: texture_storage_2d '${e}' ✗ NOT A TEXTURE`)}else s.push(`  - binding ${i}: texture_storage_2d '${e}' ✗ MISSING`);for(let[e,r]of t.storage)i.has(e)||s.push(`  - binding ${r}: storage buffer '${e}' ✗ MISSING`);for(let[e,i]of t.samplers)r[e]||a.push(`  - binding ${i}: sampler '${e}' ⚠ MISSING (may be auto-generated)`);if(0===s.length&&0===a.length)return null;let n=[];n.push(`
${e.charAt(0).toUpperCase()+e.slice(1)} shader binding mismatch:
`),s.length>0&&(n.push("Shader declares at group(1):"),n.push(...s),n.push("")),a.length>0&&(n.push("Warnings:"),n.push(...a),n.push("")),n.push("Provided uniforms:");let o=Object.keys(r);if(o.length>0)for(let e of o){let t=r[e].value,i="number"==typeof t?"number":Array.isArray(t)?`vec${t.length}`:t&&"object"==typeof t&&"createView"in t||t&&"object"==typeof t&&"texture"in t?"texture":"unknown";n.push(`  - ${e}: ${i}`)}else n.push("  (none)");if(n.push(""),i.size>0){for(let[e]of(n.push("Provided storage buffers:"),i))n.push(`  - ${e}`);n.push("")}if(s.length>0){for(let[e]of(n.push("Fix suggestions:"),t.textures))if(!r[e]){n.push("  Add texture to uniforms:"),n.push(`    ${e}: { value: yourRenderTarget }`),n.push("  or"),n.push(`    ${e}: { value: yourRenderTarget.texture }`);break}for(let[e]of t.storage)if(!i.has(e)){n.push("  Bind storage buffer:"),n.push(`    compute.storage("${e}", yourStorageBuffer)`);break}}return s.length>0?n.join(`
`):null}("compute",s,this._uniforms,this.storageBuffers);a&&console.error(a);let n=[];for(let[e,{texture:t,sampler:r}]of(this.uniformBuffer&&void 0!==s.uniformBuffer&&n.push({binding:s.uniformBuffer,resource:{buffer:this.uniformBuffer}}),c(this._uniforms))){let i=s.storageTextures.get(e);if(void 0!==i){n.push({binding:i,resource:t.createView()});continue}let a=s.textures.get(e);if(void 0!==a){if(n.push({binding:a,resource:t.createView()}),r){let t=s.samplers.get(`${e}Sampler`);void 0===t&&(t=s.samplers.get(`${e}_sampler`)),void 0===t&&e.endsWith("Tex")&&(t=s.samplers.get(`${e.slice(0,-3)}Sampler`)),void 0===t&&e.endsWith("Texture")&&(t=s.samplers.get(`${e.slice(0,-7)}Sampler`)),void 0!==t?n.push({binding:t,resource:r}):s.samplers.size>0&&console.warn(`[ralph-gpu] Sampler provided for texture '${e}' but could not find matching sampler binding in shader. Expected '${e}Sampler', '${e}_sampler', or similar.`)}}else console.warn(`[ralph-gpu] Texture '${e}' provided in uniforms but not found in shader bindings.`)}for(let[e,t]of this.storageBuffers){let r=s.storage.get(e);void 0!==r&&n.push({binding:r,resource:{buffer:t.gpuBuffer}})}this.pipeline=this.device.createComputePipeline({layout:"auto",compute:{module:r,entryPoint:"main"}}),this.needsRebuild=!1}catch(e){throw e instanceof i,e}}storage(e,t){this.storageBuffers.set(e,t),this.needsRebuild=!0}createBindGroup(){if(!this.pipeline)return null;let e=m(this.wgsl,1),t=[];for(let[r,{texture:i,sampler:s}]of(this.uniformBuffer&&void 0!==e.uniformBuffer&&t.push({binding:e.uniformBuffer,resource:{buffer:this.uniformBuffer}}),c(this._uniforms))){let a=e.storageTextures.get(r);if(void 0!==a){t.push({binding:a,resource:i.createView()});continue}let n=e.textures.get(r);if(void 0!==n){if(t.push({binding:n,resource:i.createView()}),s){let i=e.samplers.get(`${r}Sampler`);void 0===i&&(i=e.samplers.get(`${r}_sampler`)),void 0===i&&r.endsWith("Tex")&&(i=e.samplers.get(`${r.slice(0,-3)}Sampler`)),void 0===i&&r.endsWith("Texture")&&(i=e.samplers.get(`${r.slice(0,-7)}Sampler`)),void 0!==i?t.push({binding:i,resource:s}):e.samplers.size>0&&console.warn(`[ralph-gpu] Sampler provided for texture '${r}' but could not find matching sampler binding in shader. Expected '${r}Sampler', '${r}_sampler', or similar.`)}}else console.warn(`[ralph-gpu] Texture '${r}' provided in uniforms but not found in shader bindings.`)}for(let[r,i]of this.storageBuffers){let s=e.storage.get(r);void 0!==s&&t.push({binding:s,resource:{buffer:i.gpuBuffer}})}if(t.length>0){let e=this.pipeline.getBindGroupLayout(1);return this.device.createBindGroup({layout:e,entries:t})}return null}dispatch(e,t=1,r=1){if(this.context){let i={type:"compute",phase:"start",timestamp:performance.now(),id:d(),workgroups:[e,t,r],workgroupSize:this.workgroupSize,totalInvocations:e*t*r*this.workgroupSize[0]*this.workgroupSize[1]*this.workgroupSize[2]};this.context.emitEvent(i)}if((!this.pipeline||this.needsRebuild)&&this.buildPipeline(),!this.pipeline)throw Error("Failed to create compute pipeline");this.uniformBuffer&&this.uniformBufferSize>0&&l(this.device,this.uniformBuffer,this._uniforms,this.uniformBufferSize);let i=this.device.createCommandEncoder(),s=i.beginComputePass();if(s.setPipeline(this.pipeline),this.usesGlobals){let e=this.device.createBindGroup({layout:this.pipeline.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:this.globalsBuffer}}]});s.setBindGroup(0,e)}let a=this.createBindGroup();if(a&&s.setBindGroup(1,a),s.dispatchWorkgroups(e,t,r),s.end(),this.device.queue.submit([i.finish()]),this.context){let i={type:"compute",phase:"end",timestamp:performance.now(),id:d(),workgroups:[e,t,r],workgroupSize:this.workgroupSize,totalInvocations:e*t*r*this.workgroupSize[0]*this.workgroupSize[1]*this.workgroupSize[2]};this.context.emitEvent(i)}}dispose(){this.uniformBuffer&&this.uniformBuffer.destroy()}}class B{_read;_write;constructor(e,t,r,i={}){this._read=new v(e,t,r,i),this._write=new v(e,t,r,i)}get read(){return this._read}get write(){return this._write}swap(){let e=this._read;this._read=this._write,this._write=e}resize(e,t){this._read.resize(e,t),this._write.resize(e,t)}dispose(){this._read.dispose(),this._write.dispose()}}class F{device;buffer;_byteSize;context;constructor(e,t,r){if(this.device=e,this._byteSize=t,this.context=r,this.buffer=e.createBuffer({size:t,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST|GPUBufferUsage.COPY_SRC|GPUBufferUsage.INDEX}),this.context){let e={type:"memory",timestamp:performance.now(),id:d(),resourceType:"buffer",size:t,action:"allocate"};this.context.emitEvent(e)}}get gpuBuffer(){return this.buffer}get byteSize(){return this._byteSize}write(e,t=0){e instanceof ArrayBuffer?this.device.queue.writeBuffer(this.buffer,t,e):this.device.queue.writeBuffer(this.buffer,t,e.buffer,e.byteOffset,e.byteLength)}dispose(){if(this.context){let e={type:"memory",timestamp:performance.now(),id:d(),resourceType:"buffer",size:this._byteSize,action:"free"};this.context.emitEvent(e)}this.buffer.destroy()}}let C=`
fn quadOffset(vid: u32) -> vec2f {
  // 2 triangles: 0,1,2 and 3,4,5
  // Positions: BL, BR, TL, TL, BR, TR
  let x = select(-0.5, 0.5, vid == 1u || vid == 4u || vid == 5u);
  let y = select(-0.5, 0.5, vid == 2u || vid == 3u || vid == 5u);
  return vec2f(x, y);
}

fn quadUV(vid: u32) -> vec2f {
  let x = select(0.0, 1.0, vid == 1u || vid == 4u || vid == 5u);
  let y = select(0.0, 1.0, vid == 2u || vid == 3u || vid == 5u);
  return vec2f(x, y);
}
`;class P{material;buffer;constructor(e,t,r){this.buffer=e.storage(r.bufferSize);let i=C+`
`+r.shader;this.material=e.material(i,{vertexCount:6,instances:t,blend:r.blend??"alpha"}),this.material.storage("particles",this.buffer)}write(e){this.buffer.write(e)}draw(){this.material.draw()}get storageBuffer(){return this.buffer}get underlyingMaterial(){return this.material}}class M{listeners=new Map;allListeners=new Set;history=[];historyIndex=0;types;maxHistory;isHistoryFull=!1;constructor(e={}){this.types=e.types?new Set(e.types):null,this.maxHistory=e.historySize??1e3}on(e,t){return this.listeners.has(e)||this.listeners.set(e,new Set),this.listeners.get(e).add(t),()=>this.off(e,t)}off(e,t){this.listeners.has(e)&&this.listeners.get(e).delete(t)}once(e,t){let r=i=>{t(i),this.off(e,r)};return this.on(e,r)}onAll(e){return this.allListeners.add(e),()=>this.offAll(e)}offAll(e){this.allListeners.delete(e)}emit(e){(!this.types||this.types.has(e.type))&&(this.maxHistory>0&&(this.isHistoryFull?this.history[this.historyIndex]=e:this.history.push(e),this.historyIndex=(this.historyIndex+1)%this.maxHistory,0!==this.historyIndex||this.isHistoryFull||(this.isHistoryFull=!0)),this.listeners.has(e.type)&&this.listeners.get(e.type).forEach(t=>t(e)),this.allListeners.forEach(t=>t(e)))}getHistory(e){let t=this.isHistoryFull?[...this.history.slice(this.historyIndex),...this.history.slice(0,this.historyIndex)]:[...this.history];if(e&&e.length>0){let r=new Set(e);return t.filter(e=>r.has(e.type))}return t}clearHistory(){this.history=[],this.historyIndex=0,this.isHistoryFull=!1}}class z{device;context;canvas;format;globalsBuffer;globals;_width;_height;_time=0;_timeScale=1;_paused=!1;_autoClear=!0;_clearColor=[0,0,0,1];_frame=0;lastFrameTime=0;currentTarget=null;viewportState=null;scissorState=null;_dpr;_dprConfig;_autoResize;debug;resizeObserver=null;samplers=new Set;eventEmitter;frameCounter=0;enableGPUTiming;constructor(e,t,r,i,s={}){if(this.device=e,this.context=t,this.canvas=r,this.format=i,this._dprConfig=s.dpr,this._autoResize=s.autoResize||!1,this._dpr=this.calculateEffectiveDpr(),this.debug=s.debug||!1,this.enableGPUTiming=s.events?.enableGPUTiming||!1,s.events?.enabled&&(this.eventEmitter=new M({types:s.events.types,historySize:s.events.historySize})),s.autoResize){let e=r.getBoundingClientRect();this._width=Math.floor(e.width*this._dpr),this._height=Math.floor(e.height*this._dpr),r.width=this._width,r.height=this._height,this.resizeObserver=new ResizeObserver(e=>{for(let t of e){let e,r,i=t.contentBoxSize?.[0];i?(e=i.inlineSize,r=i.blockSize):(e=t.contentRect.width,r=t.contentRect.height),e>0&&r>0&&(this._dpr=this.calculateEffectiveDpr(),this._width=Math.floor(e*this._dpr),this._height=Math.floor(r*this._dpr),this.canvas.width=this._width,this.canvas.height=this._height)}}),this.resizeObserver.observe(r)}else this._width=r.width,this._height=r.height;t.configure({device:e,format:i,alphaMode:"premultiplied"}),this.globalsBuffer=e.createBuffer({size:32,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),this.globals={resolution:[this._width,this._height],time:0,deltaTime:0,frame:0,aspect:this._width/this._height},this.updateGlobals()}emitEvent(e){this.eventEmitter&&this.eventEmitter.emit(e)}on(e,t){return this.eventEmitter?this.eventEmitter.on(e,t):()=>{}}off(e,t){this.eventEmitter?.off(e,t)}once(e,t){return this.eventEmitter?this.eventEmitter.once(e,t):()=>{}}onAll(e){return this.eventEmitter?this.eventEmitter.onAll(e):()=>{}}getEventHistory(e){return this.eventEmitter?.getHistory(e)||[]}calculateEffectiveDpr(){if(!this._autoResize)return 1;if(Array.isArray(this._dprConfig)){let[e,t]=this._dprConfig;return Math.max(e,Math.min(t,window.devicePixelRatio))}return"number"==typeof this._dprConfig?this._dprConfig:Math.min(window.devicePixelRatio,2)}get width(){return this._width}get height(){return this._height}get time(){return this._time}set time(e){this._time=e}get timeScale(){return this._timeScale}set timeScale(e){this._timeScale=e}get paused(){return this._paused}set paused(e){this._paused=e}get autoClear(){return this._autoClear}set autoClear(e){this._autoClear=e}get clearColor(){return[...this._clearColor]}set clearColor(e){this._clearColor=[...e]}get gpuDevice(){return this.device}updateGlobals(){var e,t,r;let i,s=performance.now()/1e3;if(0===this.lastFrameTime&&(this.lastFrameTime=s),this._paused)this.globals.deltaTime=0;else{let e=(s-this.lastFrameTime)*this._timeScale;this._time+=e,this.globals.deltaTime=e}this.lastFrameTime=s,this.globals.time=this._time,this.globals.frame=this._frame++,this.currentTarget?this.currentTarget instanceof v?(this.globals.resolution=[this.currentTarget.width,this.currentTarget.height],this.globals.aspect=this.currentTarget.width/this.currentTarget.height):this.currentTarget instanceof y&&(this.globals.resolution=[this.currentTarget.width,this.currentTarget.height],this.globals.aspect=this.currentTarget.width/this.currentTarget.height):(this.globals.resolution=[this._width,this._height],this.globals.aspect=this._width/this._height),e=this.device,t=this.globalsBuffer,r=this.globals,(i=new Float32Array(8))[0]=r.resolution[0],i[1]=r.resolution[1],i[2]=r.time,i[3]=r.deltaTime,new Uint32Array(i.buffer,16,1)[0]=r.frame,i[5]=r.aspect,e.queue.writeBuffer(t,0,i.buffer)}pass(e,t){return t&&!this.isPassOptions(t)?new x(this.device,e,this.globalsBuffer,this,{},t):new x(this.device,e,this.globalsBuffer,this,t)}isPassOptions(e){if(!e||"object"!=typeof e)return!1;if("blend"in e)return!0;if("uniforms"in e&&e.uniforms){let t=Object.keys(e.uniforms)[0];if(t&&e.uniforms[t]&&"object"==typeof e.uniforms[t]&&"value"in e.uniforms[t])return!0}return"uniforms"in e}material(e,t){return new T(this.device,e,this.globalsBuffer,this,t)}compute(e,t){return new S(this.device,e,this.globalsBuffer,this,t)}target(e,t,r){let i=e??this._width,s=t??this._height;return new v(this.device,i,s,r,this)}pingPong(e,t,r){let i=e??this._width,s=t??this._height;return new B(this.device,i,s,r)}mrt(e,t,r){let i=t??this._width,s=r??this._height;return new Proxy(new y(this.device,e,i,s),_)}storage(e){return new F(this.device,e,this)}particles(e,t){return new P(this,e,t)}createSampler(e={}){let t=new s(this.device,e);return this.samplers.add(t),t}setTarget(e){if(this.currentTarget=e,this.eventEmitter){let t,r="screen",i=[this._width,this._height];null===e?(r="screen",t=this.format):e instanceof v?(r="texture",i=[e.width,e.height],t=({rgba8unorm:"rgba8unorm",rgba16float:"rgba16float",r16float:"r16float",rg16float:"rg16float",r32float:"r32float"})[e.format]||"rgba8unorm"):e instanceof y&&(r="mrt",i=[e.width,e.height]);let s={type:"target",timestamp:performance.now(),id:d(),target:r,size:i,format:t,action:"set"};this.emitEvent(s)}}getTarget(){return this.currentTarget}isRenderingToTexture(){return null!==this.currentTarget}setViewport(e,t,r,i){void 0===e?this.viewportState=null:this.viewportState={x:e,y:t,width:r,height:i}}setScissor(e,t,r,i){void 0===e?this.scissorState=null:this.scissorState={x:e,y:t,width:r,height:i}}clear(e,t){let r=void 0!==e?e:this.currentTarget,i=t??this._clearColor,s=this.device.createCommandEncoder();if(null===r){let e={colorAttachments:[{view:this.context.getCurrentTexture().createView(),clearValue:{r:i[0],g:i[1],b:i[2],a:i[3]},loadOp:"clear",storeOp:"store"}]};s.beginRenderPass(e).end()}else if(r instanceof v){let e={colorAttachments:[{view:r.view,clearValue:{r:i[0],g:i[1],b:i[2],a:i[3]},loadOp:"clear",storeOp:"store"}]};s.beginRenderPass(e).end()}else if(r instanceof y){let e=r.getViews().map(e=>({view:e,clearValue:{r:i[0],g:i[1],b:i[2],a:i[3]},loadOp:"clear",storeOp:"store"}));s.beginRenderPass({colorAttachments:e}).end()}if(this.device.queue.submit([s.finish()]),this.eventEmitter){let e,t="screen",i=[this._width,this._height];null===r?(t="screen",e=this.format):r instanceof v?(t="texture",i=[r.width,r.height],e=({rgba8unorm:"rgba8unorm",rgba16float:"rgba16float",r16float:"r16float",rg16float:"rg16float",r32float:"r32float"})[r.format]||"rgba8unorm"):r instanceof y&&(t="mrt",i=[r.width,r.height]);let s={type:"target",timestamp:performance.now(),id:d(),target:t,size:i,format:e,action:"clear"};this.emitEvent(s)}}resize(e,t){this._width=Math.floor(e),this._height=Math.floor(t),this.canvas.width=this._width,this.canvas.height=this._height}get dpr(){return this._dpr}set dpr(e){this._dpr=e;let t=this.canvas.getBoundingClientRect();this._width=Math.floor(t.width*this._dpr),this._height=Math.floor(t.height*this._dpr),this.canvas.width=this._width,this.canvas.height=this._height}async readPixels(e=0,t=0,r=this._width,i=this._height){if(this.currentTarget&&this.currentTarget instanceof v)return this.currentTarget.readPixels(e,t,r,i);let s=256*Math.ceil(4*r/256),a=this.device.createBuffer({size:s*i,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ}),n=this.context.getCurrentTexture(),o=this.device.createCommandEncoder();o.copyTextureToBuffer({texture:n,origin:{x:e,y:t,z:0}},{buffer:a,bytesPerRow:s},{width:r,height:i,depthOrArrayLayers:1}),this.device.queue.submit([o.finish()]),await a.mapAsync(GPUMapMode.READ);let u=new Uint8Array(a.getMappedRange().slice(0));return a.unmap(),a.destroy(),u}executeDrawCall(e,t){let r,i,s=this._autoClear?"clear":"load";if(null===this.currentTarget)r=this.context.getCurrentTexture().createView(),i=this.format;else if(this.currentTarget instanceof v)r=this.currentTarget.view,i=({rgba8unorm:"rgba8unorm",rgba16float:"rgba16float",r16float:"r16float",rg16float:"rg16float",r32float:"r32float"})[this.currentTarget.format]||"rgba8unorm";else{r=this.currentTarget.getViews()[0];let e=this.currentTarget.getFirstTarget();i=e&&({rgba8unorm:"rgba8unorm",rgba16float:"rgba16float",r16float:"r16float",rg16float:"rg16float",r32float:"r32float"})[e.format]||"rgba8unorm"}let a={colorAttachments:[{view:r,clearValue:{r:this._clearColor[0],g:this._clearColor[1],b:this._clearColor[2],a:this._clearColor[3]},loadOp:s,storeOp:"store"}]};e.drawInternal(t,a,i)}beginFrame(){return this.updateGlobals(),this.frameCounter++,this.emitEvent({type:"frame",timestamp:performance.now(),id:d(),frameNumber:this.frameCounter,deltaTime:this.globals.deltaTime,time:this.globals.time,phase:"start"}),this.device.createCommandEncoder()}endFrame(e){this.device.queue.submit([e.finish()]),this.emitEvent({type:"frame",timestamp:performance.now(),id:d(),frameNumber:this.frameCounter,deltaTime:this.globals.deltaTime,time:this.globals.time,phase:"end"})}drawPass(e){let t=this.beginFrame();this.executeDrawCall(e,t),this.endFrame(t)}drawMaterial(e){let t=this.beginFrame();this.executeDrawCall(e,t),this.endFrame(t)}dispose(){for(let e of(this.resizeObserver&&(this.resizeObserver.disconnect(),this.resizeObserver=null),this.samplers))e.dispose();this.samplers.clear(),this.globalsBuffer.destroy(),this.context.unconfigure(),this.device.destroy(),this.eventEmitter&&(this.eventEmitter=void 0)}}let U={isSupported:()=>"u">typeof navigator&&"gpu"in navigator,async init(e,i={}){if(!this.isSupported())throw new t;try{let t=await navigator.gpu.requestAdapter();if(!t)throw new r("Failed to get GPU adapter");let s=await t.requestDevice(),a=e.getContext("webgpu");if(!a)throw new r("Failed to get WebGPU context");let n=navigator.gpu.getPreferredCanvasFormat();return new z(s,a,e,n,i)}catch(e){if(e instanceof t||e instanceof r)throw e;throw new r(e.message)}}};class E{ctx;enabled=!0;maxFrameHistory;autoTrackFrames;regions=new Map;activeRegions=new Map;frameHistory=[];currentFrameStartTime=0;currentFrameNumber=0;currentFrameEvents=[];currentFrameRegions=new Map;lastFrameStartTime=0;frameStats={frameCount:0,totalTime:0,minTime:1/0,maxTime:0,averageTime:0,lastTime:0};lastTickTime=0;tickHistory=[];maxTickHistory=120;tickDrawCalls=0;tickComputeDispatches=0;lastTickDrawCalls=0;lastTickComputeDispatches=0;unsubscribe=null;constructor(e,t={}){this.ctx=e,this.maxFrameHistory=t.maxFrameHistory??120,this.autoTrackFrames=t.autoTrackFrames??!0,this.unsubscribe=e.onAll(e=>this.handleEvent(e))}handleEvent(e){this.enabled&&(this.currentFrameStartTime>0&&this.currentFrameEvents.push(e),"draw"===e.type&&"start"===e.phase?this.tickDrawCalls++:"compute"===e.type&&"start"===e.phase&&this.tickComputeDispatches++,"frame"===e.type&&("start"===e.phase?this.onFrameStart(e):"end"===e.phase&&this.onFrameEnd(e)))}onFrameStart(e){let t=this.lastFrameStartTime>0?e.timestamp-this.lastFrameStartTime:0;t>0&&(this.frameStats.frameCount++,this.frameStats.totalTime+=t,this.frameStats.lastTime=t,t<this.frameStats.minTime&&(this.frameStats.minTime=t),t>this.frameStats.maxTime&&(this.frameStats.maxTime=t),this.frameStats.averageTime=this.frameStats.totalTime/this.frameStats.frameCount),this.lastFrameStartTime=e.timestamp,this.currentFrameStartTime=e.timestamp,this.currentFrameNumber=e.frameNumber,this.currentFrameEvents=[],this.currentFrameRegions.clear()}onFrameEnd(e){if(0===this.currentFrameStartTime)return;let t=e.timestamp-this.currentFrameStartTime,r=0,i=0;for(let e of this.currentFrameEvents)"draw"===e.type&&"start"===e.phase?r++:"compute"===e.type&&"start"===e.phase&&i++;let s={frameNumber:this.currentFrameNumber,timestamp:this.currentFrameStartTime,duration:t,regions:new Map(this.currentFrameRegions),drawCalls:r,computeDispatches:i};this.frameHistory.push(s),this.frameHistory.length>this.maxFrameHistory&&this.frameHistory.shift(),this.currentFrameStartTime=0,this.currentFrameNumber=0,this.currentFrameEvents=[],this.currentFrameRegions.clear()}begin(e){this.enabled&&this.activeRegions.set(e,{startTime:performance.now(),events:[]})}end(e){if(!this.enabled)return;let t=this.activeRegions.get(e);if(!t)return void console.warn(`Profiler: end() called for unknown region "${e}"`);let r=performance.now()-t.startTime,i=this.regions.get(e);i||(i={name:e,calls:0,totalTime:0,minTime:1/0,maxTime:0,averageTime:0,lastTime:0},this.regions.set(e,i)),i.calls++,i.totalTime+=r,i.lastTime=r,r<i.minTime&&(i.minTime=r),r>i.maxTime&&(i.maxTime=r),i.averageTime=i.totalTime/i.calls;let s=this.currentFrameRegions.get(e);s||(s={calls:0,totalTime:0},this.currentFrameRegions.set(e,s)),s.calls++,s.totalTime+=r,this.activeRegions.delete(e)}getRegion(e){return this.regions.get(e)}getResults(){return new Map(this.regions)}getFrameStats(){return{...this.frameStats}}tick(){let e=performance.now();if(this.lastTickTime>0){let t=e-this.lastTickTime;this.tickHistory.push(t),this.tickHistory.length>this.maxTickHistory&&this.tickHistory.shift()}this.lastTickDrawCalls=this.tickDrawCalls,this.lastTickComputeDispatches=this.tickComputeDispatches,this.tickDrawCalls=0,this.tickComputeDispatches=0,this.lastTickTime=e}getDrawCallsPerTick(){return this.lastTickDrawCalls}getComputeDispatchesPerTick(){return this.lastTickComputeDispatches}getFPS(e=60){if(this.tickHistory.length<2)return 0;let t=this.tickHistory.slice(-e),r=t.reduce((e,t)=>e+t,0)/t.length;return r>0?1e3/r:0}getFrameProfile(e){return this.frameHistory.find(t=>t.frameNumber===e)}getLastFrames(e){return this.frameHistory.slice(-e)}getAverageFrameTime(e){let t=e??this.frameHistory.length,r=this.frameHistory.slice(-t);if(r.length<2)return 0;let i=0;for(let e=1;e<r.length;e++)i+=r[e].timestamp-r[e-1].timestamp;return i/(r.length-1)}getAverageRenderTime(e){let t=e??this.frameHistory.length,r=this.frameHistory.slice(-t);return 0===r.length?0:r.reduce((e,t)=>e+t.duration,0)/r.length}reset(){this.regions.clear(),this.activeRegions.clear(),this.frameHistory=[],this.currentFrameStartTime=0,this.currentFrameNumber=0,this.currentFrameEvents=[],this.currentFrameRegions.clear(),this.lastFrameStartTime=0,this.lastTickTime=0,this.tickHistory=[],this.tickDrawCalls=0,this.tickComputeDispatches=0,this.lastTickDrawCalls=0,this.lastTickComputeDispatches=0,this.frameStats={frameCount:0,totalTime:0,minTime:1/0,maxTime:0,averageTime:0,lastTime:0}}setEnabled(e){this.enabled=e}isEnabled(){return this.enabled}dispose(){this.unsubscribe&&(this.unsubscribe(),this.unsubscribe=null),this.reset()}}let G="0.1.0";export{S as ComputeShader,r as DeviceCreationError,M as EventEmitter,z as GPUContext,T as Material,y as MultiRenderTarget,P as Particles,x as Pass,B as PingPongTarget,E as Profiler,v as RenderTarget,s as Sampler,i as ShaderCompileError,F as StorageBuffer,w as TextureReference,t as WebGPUNotSupportedError,U as gpu,G as version};