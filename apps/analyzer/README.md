# Ralph Analyzer

A Next.js web app for analyzing Ralph AI agent execution traces.

## Features

### Homepage (`/`)
Shows aggregated analysis across all ralph traces:
- **Key Metrics**: Total iterations, cost, tool calls, and errors
- **Top Tasks**: Top 10 by cost and iterations (bar charts)
- **Tool Distribution**: Pie chart and detailed breakdown of tool usage
- **Execution Timeline**: Interactive timeline showing when each ralph ran
  - Horizontal bars showing execution duration and timing
  - Blue bars = completed tasks (called "done")
  - Red bars = incomplete tasks (no "done" call)
  - Tool call density visualization (vertical lines)
  - **Zoom controls**: Zoom in/out buttons (1x to 10x)
  - **Pan**: Drag timeline to navigate when zoomed
  - **Mouse wheel**: Ctrl/Cmd+scroll to zoom
  - **Hover tooltip**: Shows task title, cost, tool calls, duration, and timestamps
  - **Click to navigate**: Click any bar to view trace details

### Individual Trace Details (`/trace/[taskId]`)
Detailed analytics for a single trace:
- **Cost Analysis**: 
  - Total cost, tokens, and average cost per iteration
  - Line chart showing cost per iteration
  - Stacked bar chart for input/output token usage
- **Tool Usage**:
  - Pie chart showing distribution of tool calls
  - Bar chart of total duration by tool
  - Statistics grid with call counts and average durations
- **Error Patterns**:
  - Display of tool errors with details
  - Stuck detection events
  - Visual indicators for problematic runs
- **Timeline**: Chronological view of iterations and tool calls

### Navigation
- **Sidebar**: Persistent on all pages, shows all traces sorted latest-first
- **Back Button**: Returns to overview from detail pages
- **Click to Navigate**: Click any trace in sidebar to view details

## Development

```bash
cd apps/analyzer
pnpm install
pnpm dev
```

The app will run on http://localhost:3002

## How It Works

1. **Trace Loading**: Scans `ralphs/*/traces/*.ndjson` files at build/request time
2. **Data Parsing**: Parses NDJSON (newline-delimited JSON) trace events
3. **Aggregation**: Calculates statistics across all tasks
4. **Visualization**: Uses Recharts for interactive charts

## Architecture

```
apps/analyzer/
├── app/
│   ├── page.tsx              # Main dashboard
│   ├── layout.tsx            # App layout
│   ├── globals.css           # Tailwind styles
│   └── api/
│       └── traces/route.ts   # API endpoint
├── lib/
│   ├── trace-loader.ts       # Scan and parse traces
│   └── types.ts              # TypeScript types
└── components/
    ├── TaskList.tsx          # Sidebar task list
    ├── Timeline.tsx          # Event timeline
    ├── CostChart.tsx         # Cost visualizations
    ├── ToolUsage.tsx         # Tool usage charts
    └── ErrorPatterns.tsx     # Error analysis
```

## Trace Data

The analyzer reads trace files generated by ralph tasks with `trace: true` enabled:

```typescript
const agent = new LoopAgent({
  task: "...",
  trace: true, // Enables tracing
});
```

Trace files are NDJSON format with events like:
- `agent_start`, `agent_complete`, `agent_error`
- `iteration_start`, `iteration_end`
- `tool_call`, `tool_result`, `tool_error`
- `stuck_detected`, `nudge_injected`
- `summary` (final aggregated stats)
